{%- assign _excerpt_truncate = include.excerpt_truncate | default: 350 -%}
{%- assign _excerpt_type = include.excerpt_type -%}

{%- include snippets/get-locale-string.html key='READMORE' -%}
{%- assign _locale_readmore = __return -%}

{%- assign _sorted_list = include.articles-%}

{%- if include.reverse -%}
  {%- assign _sorted_list = _sorted_list | reverse -%}
{%- endif -%}

{%- comment -%} Collect all unique tags and their order {%- endcomment -%}
{%- assign _all_tags = "" | split: "" -%}
{%- assign _sorted_tags = "PI,Postdoc,PhD,MSc,BSc,Intern,Alumni" | split: "," -%}

{%- comment -%} Now render articles grouped by tags {%- endcomment -%}
{%- for _current_tag in _sorted_tags -%}

  {%- comment -%} Count articles with this tag {%- endcomment -%}
  {%- assign _tag_count = 0 -%}
  {%- for _article in _sorted_list -%}
    {%- assign _article_tags = _article.tags | join: "," -%}
    {%- if _article_tags contains _current_tag -%}
      {%- assign _tag_count = _tag_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if _tag_count > 0 -%}
    {%- assign _tag_id = _current_tag | slugify -%}
    {%- assign _tagged_articles = "" | split: "" -%}
    <div class="lab-group">
      {%- unless _current_tag == "PI" -%}
        <h4 id="{{ _tag_id }}" class="pubyear">
          <a href="#{{ _tag_id }}" class="anchor-link">#</a>
          {{ _current_tag }}
        </h4>
      {%- endunless -%}

      {%- if include.type == 'grid' -%}
        {%- if include.size == 'sm' -%}
        <div class="article-list grid grid--sm grid--p-3 lab-grid-centered">
        {%- else -%}
        <div class="article-list grid grid--p-3 lab-grid-centered">
        {%- endif -%}
      {%- else -%}
        <div class="article-list items">
      {%- endif -%}

      {%- for _article in _sorted_list -%}
        {%- assign _article_tags = _article.tags | join: "," -%}
        {%- if _article_tags contains _current_tag -%}
          {%- assign _tagged_articles = _tagged_articles | push: _article -%}
        {%- endif -%}
      {%- endfor -%}

      {%- comment -%} Sort tagged articles alphabetically by title {%- endcomment -%}
      {%- assign _tagged_articles = _tagged_articles | sort: 'title' -%}

      {%- for _article in _tagged_articles -%}

          {%- include snippets/prepend-baseurl.html path=_article.url -%}
          {%- assign _article_url = __return -%}

          {%- if _article.cover -%}
            {%- include snippets/get-nav-url.html path=_article.cover -%}
            {%- assign _article_cover = __return -%}
          {%- endif -%}

          {%- if include.type == 'grid' -%}
            {%- if include.size == 'sm' -%}
              <div class="cell cell--12 cell--md-4 cell--lg-3">
                <div class="card card--flat lab-member-card">
                  {%- if _article.cover -%}
                    <div class="card__image">
                      <img class="image" src="{{ _article_cover }}" style="width: 100%; height: auto; display: block;" />
                    </div>
                  {%- endif -%}
                </div>
              </div>
            {%- else -%}
              <div class="cell cell--12 cell--md-6 cell--lg-4">
                <div class="card card--flat lab-member-card">
                  {%- if _article.cover -%}
                    <div class="card__image"><img src="{{ _article_cover }}" style="width: 100%; height: auto; display: block;" /></div>
                  {%- endif -%}
                  <div class="card__content">
                    <header style="text-align: center;">
                      <h2 class="card__header lab-member-name">{{ _article.title }}</h2>
                      {%- if _article.note -%}
                        <p class="lab-member-note">{{ _article.note }}</p>
                      {%- endif -%}
                      {%- if _article.email or _article.github or _article.website or _article.linkedin or _article.twitter -%}
                        <div class="lab-member-links">
                          {%- if _article.email -%}
                            <a href="mailto:{{ _article.email }}" title="Email" class="lab-icon">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            </a>
                          {%- endif -%}
                          {%- if _article.github -%}
                            <a href="https://github.com/{{ _article.github }}" target="_blank" title="GitHub" class="lab-icon">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                            </a>
                          {%- endif -%}
                          {%- if _article.linkedin -%}
                            <a href="https://linkedin.com/in/{{ _article.linkedin }}" target="_blank" title="LinkedIn" class="lab-icon">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
                            </a>
                          {%- endif -%}
                          {%- if _article.twitter -%}
                            <a href="https://twitter.com/{{ _article.twitter }}" target="_blank" title="Twitter" class="lab-icon">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
                            </a>
                          {%- endif -%}
                          {%- if _article.website -%}
                            <a href="{{ _article.website }}" target="_blank" title="Website" class="lab-icon">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                            </a>
                          {%- endif -%}
                        </div>
                      {%- endif -%}
                    </header>
                  </div>
                </div>
              </div>
            {%- endif -%}
          {%- else -%}
            {%- comment -%} Item type rendering {%- endcomment -%}
            <article class="item">
              {%- if _article.cover and include.show_cover-%}
                <div class="item__image">
                  {%- if include.cover_size == 'lg' -%}
                    <img class="image image--lg" src="{{ _article_cover }}" style="width: 100%; height: auto; display: block;" />
                  {%- elsif include.cover_size == 'sm' -%}
                    <img class="image image--sm" src="{{ _article_cover }}" style="width: 100%; height: auto; display: block;" />
                  {%- else -%}
                    <img class="image" src="{{ _article_cover }}" style="width: 100%; height: auto; display: block;" />
                  {%- endif -%}
                </div>
              {%- endif -%}
              <div class="item__content">
                <header><h2 itemprop="headline" class="item__header" style="text-align:center">{{ _article.title }}</h2></header>
                <div class="item__description">
                  {%- if _article.excerpt and include.show_excerpt -%}
                    <div class="article__content" itemprop="description articleBody">
                      {%- if _excerpt_type == 'html' -%}
                        {{ _article.excerpt }}
                      {%- else -%}
                        {{ _article.excerpt | strip_html | strip | truncate: _excerpt_truncate }}
                      {%- endif -%}
                    </div>
                  {%- endif -%}
                  {%- if include.show_readmore -%}
                    <p>{{ _locale_readmore }}</p>
                  {%- endif -%}
                </div>
              </div>
            </article>
          {%- endif -%}
      {%- endfor -%}

      </div>
    </div>
  {%- endif -%}
{%- endfor -%}

<style>
.lab-group {
  margin-bottom: 0.5rem;
}

.lab-group .grid {
  row-gap: 0.5rem;
}

.lab-group .cell {
  margin-bottom: 0;
}

/* Center grid when there are fewer items than columns */
.lab-grid-centered {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}

.pubyear {
  position: relative;
  text-align: left;
  margin-bottom: 1rem;
  padding-bottom: 0.3rem;
}

.pubyear .anchor-link {
  position: absolute;
  left: -1.2em;
  color: #ccc;
  text-decoration: none;
  opacity: 1;
  transition: opacity 0.2s ease;
  font-weight: normal;
  padding-right: 0.3em;
}

.pubyear:hover .anchor-link {
  opacity: 1;
}

.pubyear .anchor-link:hover {
  color: #3498db;
}

/* Remove hyperlink styling from names */
.lab-member-card .card__header.lab-member-name,
.lab-member-card .card__header.lab-member-name:hover,
.lab-member-name {
  text-align: center;
  margin-bottom: 0.0rem;
  color: inherit !important;
  cursor: default;
  text-decoration: none !important;
  border-bottom: none !important;
  font-size: 1rem !important;
}

.lab-member-name:hover {
  color: inherit !important;
  text-decoration: none !important;
  border-bottom: none !important;
}

.lab-member-note {
  text-align: center;
  font-size: 0.85rem;
  color: #666;
  font-style: italic;
  margin: -0.2rem 0 0.0rem 0;
}

.lab-member-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.lab-member-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.lab-member-card .card__image {
  max-width: 250px;
  margin: 0 auto;
  overflow: hidden;
}

.lab-member-card .card__image img {
  width: 100%;
  height: auto;
  display: block;
}

.lab-member-links {
  display: flex;
  justify-content: center;
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.lab-icon {
  color: #666;
  transition: color 0.2s ease, transform 0.2s ease;
  display: inline-flex;
  align-items: center;
}

.lab-icon:hover {
  color: #2196F3;
  transform: scale(1.1);
}

.lab-icon svg {
  display: block;
}
</style>